<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SatAnchor ‚Äî Bitcoin Time Protocol</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg:      #080b0f;
  --surface: #0e1318;
  --panel:   #131920;
  --border:  #1e2830;
  --border2: #2a3540;
  --gold:    #d4a843;
  --gold2:   #f0c060;
  --amber:   #e07820;
  --blue:    #4a90c4;
  --green:   #3a9a6a;
  --red:     #c04040;
  --text:    #dde4ec;
  --muted:   #5a6878;
  --muted2:  #8a9aaa;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'DM Mono',monospace;font-size:13px;line-height:1.6;min-height:100vh;}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 50% at 20% 10%,rgba(74,144,196,.04) 0%,transparent 60%),radial-gradient(ellipse 60% 40% at 80% 80%,rgba(212,168,67,.03) 0%,transparent 50%);pointer-events:none;z-index:0;}
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

/* HEADER */
header{display:flex;align-items:center;justify-content:space-between;padding:0 40px;height:60px;border-bottom:1px solid var(--border);background:rgba(8,11,15,.95);backdrop-filter:blur(16px);position:sticky;top:0;z-index:200;}
.logo-name{font-family:'Playfair Display',serif;font-size:20px;color:var(--gold);letter-spacing:.05em;}
.logo-tag{font-size:9px;letter-spacing:.3em;color:var(--muted);text-transform:uppercase;margin-left:10px;}
.header-right{display:flex;align-items:center;gap:16px;}
.block-live{display:flex;align-items:center;gap:8px;font-size:11px;color:var(--muted2);}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:blink 2s ease-in-out infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:.3;}}
.net-badge{font-size:9px;letter-spacing:.2em;text-transform:uppercase;padding:3px 9px;border:1px solid rgba(224,120,32,.4);color:var(--amber);}
.btn-wallet{display:flex;align-items:center;gap:8px;padding:8px 16px;background:transparent;border:1px solid var(--border2);color:var(--muted2);font-family:'DM Mono',monospace;font-size:11px;letter-spacing:.1em;cursor:pointer;transition:all .15s;position:relative;}
.btn-wallet:hover{border-color:var(--gold);color:var(--gold);}
.btn-wallet.connected{border-color:var(--green);color:var(--green);}
.wallet-menu{position:absolute;top:calc(100% + 8px);right:0;background:var(--panel);border:1px solid var(--border2);min-width:210px;z-index:300;display:none;}
.wallet-menu.open{display:block;}
.wallet-menu-item{padding:12px 16px;cursor:pointer;display:flex;align-items:center;gap:10px;font-size:11px;color:var(--muted2);transition:all .1s;border-bottom:1px solid var(--border);}
.wallet-menu-item:last-child{border-bottom:none;}
.wallet-menu-item:hover{background:var(--surface);color:var(--text);}
.wallet-menu-item.danger{color:var(--red);}

/* NAV */
nav{display:flex;padding:0 40px;border-bottom:1px solid var(--border);}
.nav-tab{padding:14px 20px;font-size:11px;letter-spacing:.15em;text-transform:uppercase;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;position:relative;bottom:-1px;}
.nav-tab:hover{color:var(--muted2);}
.nav-tab.active{color:var(--gold);border-bottom-color:var(--gold);}

/* PAGES */
.page{display:none;padding:40px;max-width:1100px;margin:0 auto;}
.page.active{display:block;}

/* SECTION HEADER */
.sh{display:flex;align-items:center;gap:12px;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid var(--border);}
.sh-title{font-size:10px;letter-spacing:.3em;text-transform:uppercase;color:var(--muted);}
.sh-badge{font-size:9px;padding:2px 8px;border:1px solid var(--border2);color:var(--gold);}

/* STATS */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:var(--border);border:1px solid var(--border);margin-bottom:32px;}
.stat{background:var(--panel);padding:24px;}
.stat-num{font-family:'Playfair Display',serif;font-size:32px;color:var(--gold);display:block;margin-bottom:4px;}
.stat-label{font-size:9px;letter-spacing:.2em;text-transform:uppercase;color:var(--muted);}

/* HALVING */
.halving{display:flex;gap:32px;align-items:center;background:var(--panel);border:1px solid var(--border);padding:24px;margin-bottom:32px;}
.halv-n{font-family:'Playfair Display',serif;font-size:48px;color:var(--gold);line-height:1;}
.halv-label{font-size:9px;letter-spacing:.25em;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
.halv-val{font-size:16px;color:var(--text);}
.halv-sub{font-size:11px;color:var(--muted2);margin-top:4px;}

/* TIMELINE */
.timeline-bar{height:2px;background:var(--border);position:relative;margin:28px 0 36px;}
.timeline-fill{position:absolute;left:0;top:0;height:100%;background:linear-gradient(90deg,var(--border2),var(--gold));transition:width .5s;}
.timeline-pts{display:flex;justify-content:space-between;margin-top:-22px;}
.t-pt{display:flex;flex-direction:column;align-items:center;gap:6px;}
.t-dot{width:10px;height:10px;border-radius:50%;border:2px solid var(--border2);background:var(--bg);position:relative;z-index:1;}
.t-dot.done{border-color:var(--gold);background:var(--gold);}
.t-dot.now{border-color:var(--amber);background:var(--bg);box-shadow:0 0 0 3px rgba(224,120,32,.2);}
.t-lbl{font-size:9px;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;white-space:nowrap;}
.t-blk{font-size:11px;color:var(--muted2);}

/* ANCHOR ROWS */
.anchor-row{background:var(--panel);border:1px solid var(--border);border-left:3px solid var(--border2);padding:18px 24px;margin-bottom:1px;display:grid;grid-template-columns:120px 1fr auto auto;gap:16px;align-items:center;cursor:pointer;transition:all .1s;animation:rowIn .3s ease forwards;opacity:0;}
@keyframes rowIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}
.anchor-row:hover{background:var(--surface);border-color:var(--border2);}
.anchor-row.pub{border-left-color:var(--gold);}
.anchor-row.enc{border-left-color:var(--amber);}
.ar-id{font-size:10px;color:var(--muted);}
.ar-id span{color:var(--gold);}
.ar-msg{font-family:'Playfair Display',serif;font-size:15px;font-style:italic;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ar-msg.enc{font-family:'DM Mono',monospace;font-size:11px;font-style:normal;color:var(--muted);}
.ar-cond{font-size:11px;color:var(--muted2);text-align:right;white-space:nowrap;}
.ar-cond strong{display:block;color:var(--text);}
.pill{font-size:9px;letter-spacing:.15em;text-transform:uppercase;padding:3px 8px;border:1px solid;white-space:nowrap;}
.pill.pending{color:var(--muted);border-color:var(--border2);}
.pill.active{color:var(--green);border-color:var(--green);}
.pill.unlockable{color:var(--amber);border-color:var(--amber);animation:glow 2s ease-in-out infinite;}
.pill.spent{color:var(--muted);border-color:var(--border);}
@keyframes glow{0%,100%{box-shadow:0 0 0 transparent;}50%{box-shadow:0 0 8px rgba(224,120,32,.3);}}

/* CONNECT PROMPT */
.connect-prompt{border:1px solid var(--border);padding:48px;text-align:center;margin-bottom:32px;}
.cp-title{font-family:'Playfair Display',serif;font-size:24px;color:var(--muted);margin-bottom:12px;}
.cp-sub{font-size:11px;color:var(--muted);margin-bottom:28px;line-height:1.8;}
.cp-btns{display:flex;gap:12px;justify-content:center;}

/* CREATE PAGE */
.create-layout{display:grid;grid-template-columns:1fr 360px;gap:32px;align-items:start;}
.form-panel{background:var(--panel);border:1px solid var(--border);padding:32px;}
.field{margin-bottom:22px;}
.field-label{font-size:9px;letter-spacing:.25em;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:8px;}
.field-input{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:13px;padding:12px 14px;outline:none;transition:border-color .15s;}
.field-input:focus{border-color:var(--border2);}
.field-input::placeholder{color:var(--muted);}
textarea.field-input{min-height:90px;resize:vertical;font-family:'Playfair Display',serif;font-style:italic;font-size:15px;}
select.field-input{appearance:none;cursor:pointer;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%235a6878'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;}
.cond-tabs{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--border);margin-bottom:12px;}
.cond-tab{background:var(--surface);padding:10px;text-align:center;font-size:10px;letter-spacing:.15em;text-transform:uppercase;color:var(--muted);cursor:pointer;transition:all .1s;}
.cond-tab:hover{color:var(--muted2);}
.cond-tab.active{background:var(--panel);color:var(--gold);border-bottom:2px solid var(--gold);}
.encrypt-row{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--bg);border:1px solid var(--border);cursor:pointer;transition:border-color .15s;margin-bottom:22px;}
.encrypt-row:hover{border-color:var(--border2);}
.encrypt-row.on{border-color:rgba(224,120,32,.5);}
.toggle{width:36px;height:20px;background:var(--border2);border-radius:10px;position:relative;transition:background .2s;flex-shrink:0;}
.toggle::after{content:'';position:absolute;width:14px;height:14px;border-radius:50%;background:var(--muted2);top:3px;left:3px;transition:all .2s;}
.encrypt-row.on .toggle{background:rgba(224,120,32,.3);}
.encrypt-row.on .toggle::after{transform:translateX(16px);background:var(--amber);}
.btn-primary{width:100%;background:var(--gold);color:var(--bg);border:none;font-family:'DM Mono',monospace;font-size:11px;letter-spacing:.2em;text-transform:uppercase;padding:16px;cursor:pointer;transition:all .15s;}
.btn-primary:hover{background:var(--gold2);}
.btn-primary:disabled{background:var(--border2);color:var(--muted);cursor:not-allowed;}
.btn-sec{background:transparent;color:var(--muted2);border:1px solid var(--border2);font-family:'DM Mono',monospace;font-size:11px;letter-spacing:.1em;text-transform:uppercase;padding:10px 18px;cursor:pointer;transition:all .15s;}
.btn-sec:hover{border-color:var(--text);color:var(--text);}

/* PREVIEW */
.preview-panel{background:var(--panel);border:1px solid var(--border);padding:28px;position:sticky;top:80px;}
.prev-vault{background:var(--bg);border:1px solid var(--border);padding:20px;margin-bottom:16px;}
.prev-id{font-size:9px;color:var(--muted);margin-bottom:8px;letter-spacing:.08em;}
.prev-msg{font-family:'Playfair Display',serif;font-size:16px;font-style:italic;min-height:24px;margin-bottom:10px;}
.prev-cond{font-size:11px;color:var(--muted2);}
.prev-hash{font-size:9px;color:var(--muted);margin-top:6px;word-break:break-all;letter-spacing:.04em;}
.proto-box{background:var(--bg);border:1px solid var(--border);padding:14px;font-size:10px;color:var(--muted);line-height:1.9;}
.proto-box span{color:var(--muted2);}

/* TX PROGRESS */
.tx-progress{background:var(--bg);border:1px solid var(--border);padding:18px;margin-top:14px;}
.tx-step{display:flex;align-items:center;gap:12px;padding:7px 0;font-size:11px;color:var(--muted);}
.tx-step.done{color:var(--green);}
.tx-step.active{color:var(--text);}
.tx-step.error{color:var(--red);}
.step-dot{width:8px;height:8px;border-radius:50%;background:var(--border2);flex-shrink:0;}
.tx-step.done .step-dot{background:var(--green);}
.tx-step.active .step-dot{background:var(--blue);animation:blink 1s infinite;}
.tx-step.error .step-dot{background:var(--red);}

/* SUCCESS / KEY BOX */
.success-box{background:rgba(58,154,106,.08);border:1px solid rgba(58,154,106,.3);padding:16px;margin-top:14px;}
.success-label{font-size:9px;letter-spacing:.2em;text-transform:uppercase;color:var(--green);margin-bottom:8px;}
.key-box{background:rgba(224,120,32,.06);border:1px solid rgba(224,120,32,.3);padding:16px;margin-top:12px;}
.key-label{font-size:9px;letter-spacing:.15em;text-transform:uppercase;color:var(--amber);margin-bottom:8px;}
.key-val{font-size:10px;color:var(--text);word-break:break-all;line-height:1.7;}
.copy-btn{font-size:9px;letter-spacing:.1em;padding:4px 10px;border:1px solid var(--border2);color:var(--muted);background:none;cursor:pointer;transition:all .1s;margin-top:8px;}
.copy-btn:hover{color:var(--text);border-color:var(--text);}
a.txlink{color:var(--blue);text-decoration:none;font-size:10px;word-break:break-all;}
a.txlink:hover{text-decoration:underline;}

/* ARCHIVE */
.filter-bar{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap;}
.fbtn{font-size:9px;letter-spacing:.15em;text-transform:uppercase;padding:5px 12px;border:1px solid var(--border2);color:var(--muted);background:transparent;cursor:pointer;transition:all .1s;}
.fbtn:hover{color:var(--muted2);}
.fbtn.active{color:var(--gold);border-color:var(--gold);}
.archive-table{width:100%;border-collapse:collapse;}
.archive-table th{font-size:9px;letter-spacing:.2em;text-transform:uppercase;color:var(--muted);padding:10px 14px;text-align:left;border-bottom:1px solid var(--border);font-weight:400;}
.archive-table td{padding:13px 14px;border-bottom:1px solid var(--border);font-size:11px;color:var(--muted2);vertical-align:middle;}
.archive-table tr{cursor:pointer;transition:background .1s;}
.archive-table tr:hover td{background:var(--panel);}
.archive-table tr.mine td{border-left:2px solid var(--gold);}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(6px);z-index:500;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s;}
.overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--panel);border:1px solid var(--border2);width:540px;max-width:95vw;max-height:85vh;overflow-y:auto;transform:translateY(16px);transition:transform .2s;}
.overlay.open .modal{transform:translateY(0);}
.modal-head{padding:22px 26px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:start;}
.modal-title{font-family:'Playfair Display',serif;font-size:20px;color:var(--gold);}
.modal-close{background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px;padding:2px;transition:color .1s;}
.modal-close:hover{color:var(--text);}
.modal-body{padding:22px 26px;}
.modal-row{display:flex;justify-content:space-between;align-items:baseline;padding:9px 0;border-bottom:1px solid var(--border);gap:16px;}
.modal-row:last-of-type{border-bottom:none;}
.modal-key{font-size:9px;letter-spacing:.2em;text-transform:uppercase;color:var(--muted);flex-shrink:0;}
.modal-val{font-size:11px;color:var(--text);text-align:right;word-break:break-all;font-family:'DM Mono',monospace;}
.msg-box{background:var(--bg);border:1px solid var(--border);padding:18px;margin-top:14px;}
.msg-box-label{font-size:9px;letter-spacing:.2em;text-transform:uppercase;color:var(--muted);margin-bottom:8px;}
.msg-text{font-family:'Playfair Display',serif;font-size:17px;font-style:italic;line-height:1.5;}
.msg-text.enc{font-family:'DM Mono',monospace;font-size:11px;font-style:normal;color:var(--muted);}
.modal-actions{padding:0 26px 22px;display:flex;gap:10px;}

/* NOTIFICATIONS */
.notifs{position:fixed;bottom:24px;right:24px;z-index:600;display:flex;flex-direction:column;gap:8px;max-width:340px;}
.notif{background:var(--panel);border:1px solid var(--border2);border-left:3px solid var(--muted);padding:13px 16px;display:flex;align-items:flex-start;gap:10px;animation:notifIn .2s ease;}
@keyframes notifIn{from{opacity:0;transform:translateX(20px);}to{opacity:1;transform:translateX(0);}}
.notif.success{border-left-color:var(--green);}
.notif.error{border-left-color:var(--red);}
.notif.warning{border-left-color:var(--amber);}
.notif.info{border-left-color:var(--blue);}
.notif-icon{font-size:13px;flex-shrink:0;margin-top:1px;}
.notif-title{font-size:12px;color:var(--text);}
.notif-sub{font-size:10px;color:var(--muted);margin-top:2px;}
.empty{text-align:center;padding:60px 20px;color:var(--muted);}
.empty-icon{font-size:28px;display:block;margin-bottom:10px;opacity:.3;}
</style>
</head>
<body>

<header>
  <div>
    <span class="logo-name">SatAnchor</span>
    <span class="logo-tag">Bitcoin ¬∑ Layer 1</span>
  </div>
  <div class="header-right">
    <div class="block-live">
      <div class="live-dot"></div>
      <span>Block</span>
      <span id="liveBlock">‚Äî</span>
    </div>
    <span class="net-badge">Testnet</span>
    <div style="position:relative">
      <button class="btn-wallet" id="walletBtn" onclick="toggleMenu()">
        <span>‚¨°</span>
        <span id="walletLabel">Connect Wallet</span>
      </button>
      <div class="wallet-menu" id="walletMenu">
        <div class="wallet-menu-item" onclick="connectWallet('unisat')">üü† UniSat Wallet</div>
        <div class="wallet-menu-item" onclick="connectWallet('opnet')">üîµ OP_WALLET</div>
        <div class="wallet-menu-item" id="diagItem" onclick="diagnose()" style="font-size:10px;color:var(--muted)">üîç Diagnose wallets</div>
        <div class="wallet-menu-item danger" id="discItem" style="display:none" onclick="disconnect()">‚úï Disconnect</div>
      </div>
    </div>
  </div>
</header>

<nav>
  <div class="nav-tab active" data-page="dashboard" onclick="showPage(this)">Dashboard</div>
  <div class="nav-tab" data-page="create" onclick="showPage(this)">Create Anchor</div>
  <div class="nav-tab" data-page="archive" onclick="showPage(this)">Archive</div>
</nav>

<!-- DASHBOARD -->
<div class="page active" id="page-dashboard">
  <div class="stats-grid">
    <div class="stat"><span class="stat-num" id="s-total">0</span><span class="stat-label">Total Anchors</span></div>
    <div class="stat"><span class="stat-num" id="s-active">0</span><span class="stat-label">Active</span></div>
    <div class="stat"><span class="stat-num" id="s-unlock">0</span><span class="stat-label">Unlockable</span></div>
    <div class="stat"><span class="stat-num" id="s-next">‚Äî</span><span class="stat-label">Next Unlock</span></div>
  </div>

  <div class="halving">
    <div class="halv-n">5</div>
    <div>
      <div class="halv-label">Next Bitcoin Halving</div>
      <div class="halv-val">Block #1,050,000</div>
      <div class="halv-sub" id="halvSub">~162,588 blocks away</div>
    </div>
  </div>

  <div class="sh" style="display:block;border-bottom:1px solid var(--border);margin-bottom:0;padding-bottom:16px;">
    <span class="sh-title">Unlock Timeline</span>
  </div>
  <div class="timeline-bar">
    <div class="timeline-fill" id="tlFill" style="width:0%"></div>
  </div>
  <div class="timeline-pts">
    <div class="t-pt"><div class="t-dot done"></div><span class="t-lbl">Genesis</span><span class="t-blk">#0</span></div>
    <div class="t-pt"><div class="t-dot done"></div><span class="t-lbl">Halving 4</span><span class="t-blk">#840,000</span></div>
    <div class="t-pt"><div class="t-dot now"></div><span class="t-lbl" style="color:var(--amber)">Now</span><span class="t-blk" style="color:var(--amber)" id="nowBlk">#‚Äî</span></div>
    <div class="t-pt"><div class="t-dot"></div><span class="t-lbl">Halving 5</span><span class="t-blk">#1,050,000</span></div>
  </div>

  <div class="sh" style="margin-top:40px;">
    <span class="sh-title">My Anchors</span>
    <span class="sh-badge" id="myCount">0</span>
  </div>
  <div id="myList"></div>
</div>

<!-- CREATE -->
<div class="page" id="page-create">
  <div class="create-layout">
    <div>
      <div class="sh"><span class="sh-title">Create New Anchor</span></div>
      <div class="form-panel">
        <div class="field">
          <label class="field-label">Message</label>
          <textarea class="field-input" id="f-msg" placeholder="Write your message for the future..." oninput="updatePreview()"></textarea>
        </div>
        <div class="field">
          <label class="field-label">Unlock Condition</label>
          <div class="cond-tabs">
            <div class="cond-tab active" onclick="setTab('block',this)">Block Height</div>
            <div class="cond-tab" onclick="setTab('date',this)">Date</div>
            <div class="cond-tab" onclick="setTab('halving',this)">Halving</div>
          </div>
          <div id="tab-block">
            <input type="number" class="field-input" id="f-block" placeholder="e.g. 900000" oninput="updatePreview()">
            <div style="font-size:10px;color:var(--muted);margin-top:5px">Current: <span id="curBlk">loading...</span></div>
          </div>
          <div id="tab-date" style="display:none">
            <input type="date" class="field-input" id="f-date" oninput="updatePreview()">
          </div>
          <div id="tab-halving" style="display:none">
            <select class="field-input" id="f-halving" onchange="updatePreview()">
              <option value="5">Halving #5 ‚Äî Block #1,050,000</option>
              <option value="6">Halving #6 ‚Äî Block #1,260,000</option>
              <option value="7">Halving #7 ‚Äî Block #1,470,000</option>
            </select>
          </div>
        </div>
        <div class="field">
          <label class="field-label">Amount (satoshis)</label>
          <input type="number" class="field-input" id="f-amount" placeholder="e.g. 10000" min="1000" oninput="updatePreview()">
          <div style="font-size:10px;color:var(--muted);margin-top:5px">Minimum: 1000 sats</div>
        </div>
        <div class="encrypt-row" id="encRow" onclick="toggleEncrypt()">
          <div>
            <div style="font-size:11px;color:var(--text);margin-bottom:2px">Encrypt Message</div>
            <div style="font-size:10px;color:var(--muted)">AES-256-GCM ¬∑ Key shown once ¬∑ Never stored</div>
          </div>
          <div class="toggle" id="encToggle"></div>
        </div>
        <button class="btn-primary" id="createBtn" onclick="createAnchor()">Create Anchor ‚Üí</button>
        <div id="createStatus"></div>
      </div>
    </div>
    <div>
      <div class="sh"><span class="sh-title">Preview</span></div>
      <div class="preview-panel">
        <div style="font-size:11px;color:var(--muted);margin-bottom:16px;font-style:italic">Your anchor will look like this</div>
        <div class="prev-vault">
          <div class="prev-id">ID: <span style="color:var(--gold)" id="prev-id">‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî</span></div>
          <div class="prev-msg" id="prev-msg" style="color:var(--muted)">Your message here...</div>
          <div class="prev-cond" id="prev-cond" style="color:var(--muted)">Set condition above</div>
          <div class="prev-hash" id="prev-hash"></div>
        </div>
        <div style="margin-bottom:14px">
          <div style="font-size:9px;letter-spacing:.2em;text-transform:uppercase;color:var(--muted);margin-bottom:6px">Wallet</div>
          <div id="walletStatus" style="font-size:11px;color:var(--muted)">Not connected</div>
        </div>
        <div class="proto-box">
          <div>Protocol: <span>SATANCHOR_V1</span></div>
          <div>Script: <span>P2WSH + CLTV</span></div>
          <div>Network: <span style="color:var(--amber)">Bitcoin Testnet</span></div>
          <div>Commitment: <span>OP_RETURN</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ARCHIVE -->
<div class="page" id="page-archive">
  <div class="sh">
    <span class="sh-title">Anchor Archive</span>
    <span class="sh-badge" id="archCount">0</span>
  </div>
  <div class="filter-bar">
    <button class="fbtn active" onclick="setFilter('all',this)">All</button>
    <button class="fbtn" onclick="setFilter('mine',this)">Mine</button>
    <button class="fbtn" onclick="setFilter('active',this)">Active</button>
    <button class="fbtn" onclick="setFilter('unlockable',this)">Unlockable</button>
    <button class="fbtn" onclick="setFilter('spent',this)">Spent</button>
  </div>
  <table class="archive-table">
    <thead><tr>
      <th>Anchor ID</th><th>Message</th><th>Condition</th><th>Status</th><th>Type</th><th>Created</th>
    </tr></thead>
    <tbody id="archBody"></tbody>
  </table>
</div>

<!-- MODAL -->
<div class="overlay" id="modal" onclick="closeModalOuter(event)">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title" id="mTitle">Anchor</div>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body" id="mBody"></div>
    <div class="modal-actions" id="mActions"></div>
  </div>
</div>

<div class="notifs" id="notifs"></div>

<script>
'use strict';

/* ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ */
const S = {
  wallet: null,   // { type, address, pubkey, provider }
  anchors: [],
  block: 0,
  condTab: 'block',
  encrypt: false,
  archFilter: 'all',
};

const HALVING = { 5:1050000, 6:1260000, 7:1470000 };
const MEMPOOL = 'https://mempool.space/testnet/api';

/* ‚îÄ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ‚îÄ */
function load()  { try { S.anchors = JSON.parse(localStorage.getItem('satanchor_v1') || '[]'); } catch(_) { S.anchors = []; } }
function save()  { localStorage.setItem('satanchor_v1', JSON.stringify(S.anchors)); }
function addA(a) { S.anchors.unshift(a); save(); refresh(); }

/* ‚îÄ‚îÄ‚îÄ CRYPTO UTILS ‚îÄ‚îÄ‚îÄ */
const HEX = '0123456789abcdef';
function hex(bytes) { return Array.from(bytes).map(b => HEX[b>>4]+HEX[b&15]).join(''); }
function unhex(h)   { return new Uint8Array(h.match(/.{2}/g).map(b => parseInt(b,16))); }
function rand(n)    { return crypto.getRandomValues(new Uint8Array(n)); }
async function sha256hex(text) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text));
  return hex(new Uint8Array(buf));
}
async function sha256bytes(bytes) {
  return new Uint8Array(await crypto.subtle.digest('SHA-256', bytes));
}

/* ‚îÄ‚îÄ‚îÄ ENCRYPTION ‚îÄ‚îÄ‚îÄ */
async function encrypt(text) {
  const key = await crypto.subtle.generateKey({name:'AES-GCM',length:256},true,['encrypt','decrypt']);
  const iv  = rand(12);
  const ct  = await crypto.subtle.encrypt({name:'AES-GCM',iv}, key, new TextEncoder().encode(text));
  const raw = await crypto.subtle.exportKey('raw', key);
  const blob = new Uint8Array([...iv, ...new Uint8Array(ct)]);
  return {
    blob: btoa(String.fromCharCode(...blob)),
    key:  btoa(String.fromCharCode(...new Uint8Array(raw))),
  };
}
async function decrypt(blobB64, keyB64) {
  const blob = new Uint8Array(atob(blobB64).split('').map(c=>c.charCodeAt(0)));
  const raw  = new Uint8Array(atob(keyB64).split('').map(c=>c.charCodeAt(0)));
  const key  = await crypto.subtle.importKey('raw',raw,'AES-GCM',false,['decrypt']);
  const plain = await crypto.subtle.decrypt({name:'AES-GCM',iv:blob.slice(0,12)}, key, blob.slice(12));
  return new TextDecoder().decode(plain);
}

/* ‚îÄ‚îÄ‚îÄ BITCOIN / BECH32 ‚îÄ‚îÄ‚îÄ */
const CHARSET = 'qpzry9x8gf2tvdw0s3jn54khce6mua7l';
const GEN = [0x3b6a57b2,0x26508e6d,0x1ea119fa,0x3d4233dd,0x2a1462b3];

function b32Polymod(v) {
  let c=1;
  for (const x of v) { const b=c>>25; c=(c&0x1ffffff)<<5^x; for(let i=0;i<5;i++) if((b>>i)&1) c^=GEN[i]; }
  return c;
}
function b32Expand(hrp) {
  return [...hrp.split('').map(c=>c.charCodeAt(0)>>5),0,...hrp.split('').map(c=>c.charCodeAt(0)&31)];
}
function convertBits(data,from,to,pad=true) {
  let acc=0,bits=0; const ret=[],maxv=(1<<to)-1;
  for(const v of data){ acc=(acc<<from|v)&((1<<(from+to-1))-1); bits+=from; while(bits>=to){bits-=to;ret.push((acc>>bits)&maxv);} }
  if(pad&&bits) ret.push((acc<<(to-bits))&maxv);
  return ret;
}
function b32Encode(hrp,witVer,prog) {
  const data=[witVer,...convertBits(prog,8,5)];
  const exp=b32Expand(hrp);
  const poly=b32Polymod([...exp,...data,0,0,0,0,0,0])^1;
  const cs=Array.from({length:6},(_,i)=>(poly>>(5*(5-i)))&31);
  return hrp+'1'+[...data,...cs].map(d=>CHARSET[d]).join('');
}
function b32Decode(addr) {
  const lower=addr.toLowerCase();
  const sep=lower.lastIndexOf('1');
  const dataStr=lower.slice(sep+1,-6);
  const data=dataStr.split('').map(c=>CHARSET.indexOf(c));
  return new Uint8Array(convertBits(data.slice(1),5,8,false));
}

async function p2wshAddress(redeemScript) {
  const hash = await sha256bytes(redeemScript);
  return b32Encode('tb', 0, hash);  // witness v0
}

function varInt(n) {
  if (n<0xfd) return new Uint8Array([n]);
  const b=new Uint8Array(3); b[0]=0xfd; new DataView(b.buffer).setUint16(1,n,true); return b;
}
function uint32LE(n) { const b=new Uint8Array(4); new DataView(b.buffer).setUint32(0,n,true); return b; }
function uint64LE(n) { const b=new Uint8Array(8); let v=BigInt(n); for(let i=0;i<8;i++){b[i]=Number(v&0xffn);v>>=8n;} return b; }
function cat(...arrs) { const t=arrs.reduce((s,a)=>s+a.length,0),r=new Uint8Array(t); let o=0; for(const a of arrs){r.set(a,o);o+=a.length;} return r; }

/* Decode any bech32 address to scriptPubKey bytes */
function addrToScript(addr) {
  const lower = addr.toLowerCase();
  const sep   = lower.lastIndexOf('1');
  const dataStr = lower.slice(sep+1,-6);
  const data = dataStr.split('').map(c=>CHARSET.indexOf(c));
  const witVer = data[0];                  // 0=OP_0, 1=OP_1(taproot)
  const prog   = new Uint8Array(convertBits(data.slice(1),5,8,false));
  const opcode = witVer===0 ? 0x00 : (0x50+witVer);
  return new Uint8Array([opcode, prog.length, ...prog]);
}

/* ‚îÄ‚îÄ‚îÄ PSBT BUILDER (pure JS, BIP-174) ‚îÄ‚îÄ‚îÄ */
function kv(key, val) {
  return cat(varInt(key.length), key, varInt(val.length), val);
}

async function buildPSBT(utxos, toAddr, toSats, changeSats, changeAddr) {
  // Build unsigned tx
  const ver  = new Uint8Array([0x02,0,0,0]);
  const lock = new Uint8Array([0,0,0,0]);
  const seq  = new Uint8Array([0xfd,0xff,0xff,0xff]);

  const ins  = utxos.map(u => cat(
    unhex(u.transactionId).reverse(),
    uint32LE(u.outputIndex),
    new Uint8Array([0x00]),   // empty scriptSig
    seq
  ));

  const outs = [];
  const toScript  = addrToScript(toAddr);
  outs.push(cat(uint64LE(toSats), varInt(toScript.length), toScript));
  if (changeSats >= 546) {
    const chScript = addrToScript(changeAddr);
    outs.push(cat(uint64LE(changeSats), varInt(chScript.length), chScript));
  }

  const unsignedTx = cat(
    ver,
    varInt(ins.length), ...ins,
    varInt(outs.length), ...outs,
    lock
  );

  // x-only pubkey (Taproot) ‚Äî 32 bytes, drop 02/03 prefix
  const pub = S.wallet.pubkey || '';
  const xOnly = pub.length >= 64
    ? unhex(pub.length===66 ? pub.slice(2) : pub.slice(0,64))
    : null;

  // PSBT assembly
  const MAGIC = new Uint8Array([0x70,0x73,0x62,0x74,0xff]); // "psbt\xff"
  const parts  = [MAGIC];

  // Global: unsigned tx (key type 0x00)
  parts.push(kv(new Uint8Array([0x00]), unsignedTx));
  parts.push(new Uint8Array([0x00])); // end globals

  // Per-input
  for (const u of utxos) {
    const spk    = unhex(u.scriptPubKey.hex);
    const value  = parseInt(u.value);

    // PSBT_IN_WITNESS_UTXO (0x01)
    const witnessUtxo = cat(uint64LE(value), varInt(spk.length), spk);
    parts.push(kv(new Uint8Array([0x01]), witnessUtxo));

    // PSBT_IN_TAP_INTERNAL_KEY (0x15) ‚Äî x-only pubkey, tells wallet which key to use
    if (xOnly && xOnly.length===32) {
      parts.push(kv(new Uint8Array([0x15]), xOnly));
    }

    parts.push(new Uint8Array([0x00])); // end input
  }

  // Per-output (empty)
  for (let i=0; i<outs.length; i++) parts.push(new Uint8Array([0x00]));

  return hex(cat(...parts));
}

/* ‚îÄ‚îÄ‚îÄ MEMPOOL API ‚îÄ‚îÄ‚îÄ */
async function fetchBlock() {
  try {
    const h = await (await fetch(`${MEMPOOL}/blocks/tip/height`)).json();
    S.block = h;
    document.getElementById('liveBlock').textContent = h.toLocaleString();
    document.getElementById('nowBlk').textContent    = '#'+h.toLocaleString();
    document.getElementById('curBlk').textContent    = '#'+h.toLocaleString();
    document.getElementById('tlFill').style.width    = Math.min(100,(h/1050000)*100)+'%';
    const left = 1050000-h;
    document.getElementById('halvSub').textContent   = `~${left.toLocaleString()} blocks away ¬∑ approx. ${Math.floor(Date.now()/1000+left*600) ? new Date((Date.now()+left*600000)).getFullYear() : ''}`;
    refreshStats();
  } catch(_) { document.getElementById('liveBlock').textContent='offline'; }
}

/* ‚îÄ‚îÄ‚îÄ WALLET ‚îÄ‚îÄ‚îÄ */
function toggleMenu() {
  document.getElementById('walletMenu').classList.toggle('open');
}
document.addEventListener('click', e => {
  if (!document.getElementById('walletBtn').contains(e.target))
    document.getElementById('walletMenu').classList.remove('open');
});

async function connectWallet(type) {
  document.getElementById('walletMenu').classList.remove('open');
  await new Promise(r=>setTimeout(r,100));

  if (type==='unisat') {
    if (!window.unisat) {
      notify('UniSat not found','Install the UniSat extension first','error');
      window.open('https://unisat.io/download','_blank'); return;
    }
    try {
      notify('Connecting...','Waiting for UniSat','info');
      const accounts = await window.unisat.requestAccounts();
      const pubkey   = await window.unisat.getPublicKey();
      try { const n=await window.unisat.getNetwork(); if(!n.includes('test')) await window.unisat.switchNetwork('testnet'); } catch(_){}
      S.wallet = { type:'unisat', address:accounts[0], pubkey, provider:window.unisat };
      onConnected();
      notify('UniSat Connected ‚úì', trunc(accounts[0]), 'success');
    } catch(e) {
      notify('Connection failed', e.message||'User rejected', 'error');
    }
  }

  else if (type==='opnet') {
    const p = window.opnet || window.opwallet;
    if (!p) {
      notify('OP_WALLET not found','Install OP_WALLET extension and reload','error');
      window.open('https://chromewebstore.google.com/detail/opwallet/pmbjpcmaaladnfpacpmhmnfmpklgbdjb','_blank'); return;
    }
    try {
      notify('Connecting...','Waiting for OP_WALLET','info');
      const accounts = await p.requestAccounts();
      if (!accounts||!accounts[0]) throw new Error('No accounts returned');
      let pubkey='';
      try { pubkey = await p.getPublicKey(); } catch(_){}
      S.wallet = { type:'opnet', address:accounts[0], pubkey, provider:p };
      onConnected();
      notify('OP_WALLET Connected ‚úì', trunc(accounts[0]), 'success');
    } catch(e) {
      if (e.code===4001||/reject|cancel/i.test(e.message||'')) notify('Cancelled','Connection rejected','warning');
      else notify('Connection failed', e.message||'Unknown error', 'error');
    }
  }
}

function onConnected() {
  const w = S.wallet;
  const btn = document.getElementById('walletBtn');
  btn.className = 'btn-wallet connected';
  btn.innerHTML = `<span>${w.type==='unisat'?'üü†':'üîµ'}</span><span>${trunc(w.address)}</span>`;
  document.getElementById('discItem').style.display = 'flex';
  document.getElementById('walletStatus').innerHTML = `<span style="color:var(--green)">‚úì</span> ${trunc(w.address)}`;
  localStorage.setItem('sa_wtype', w.type);
  refresh();
}

function disconnect() {
  S.wallet = null;
  document.getElementById('walletMenu').classList.remove('open');
  const btn = document.getElementById('walletBtn');
  btn.className = 'btn-wallet';
  btn.innerHTML = '<span>‚¨°</span><span>Connect Wallet</span>';
  document.getElementById('discItem').style.display = 'none';
  document.getElementById('walletStatus').textContent = 'Not connected';
  localStorage.removeItem('sa_wtype');
  refresh();
  notify('Disconnected','','info');
}

function diagnose() {
  document.getElementById('walletMenu').classList.remove('open');
  const checks = [['window.unisat',window.unisat],['window.opnet',window.opnet],['window.opwallet',window.opwallet]];
  const found   = checks.filter(([,v])=>v!=null).map(([k])=>k);
  const missing = checks.filter(([,v])=>v==null).map(([k])=>k);
  notify('Wallet Detection', (found.length?'Found: '+found.join(', '):'')+' '+(missing.length?'| Missing: '+missing.join(', '):''), found.length?'success':'error');
  console.table(Object.fromEntries(checks.map(([k,v])=>[k,v?'‚úì present':'‚úó missing'])));
}

/* ‚îÄ‚îÄ‚îÄ ANCHOR CREATION ‚îÄ‚îÄ‚îÄ */
async function createAnchor() {
  if (!S.wallet) { notify('Wallet required','Connect wallet first','warning'); return; }

  const msg = document.getElementById('f-msg').value.trim();
  if (!msg) { notify('Message required','Write a message','warning'); return; }

  const amount = parseInt(document.getElementById('f-amount').value);
  if (!amount||amount<1000) { notify('Invalid amount','Minimum 1000 sats','warning'); return; }

  let cltvValue, condLabel;
  if (S.condTab==='block') {
    cltvValue = parseInt(document.getElementById('f-block').value);
    if (!cltvValue||cltvValue<=S.block) { notify('Invalid block','Must be in the future','warning'); return; }
    condLabel = `Block #${cltvValue.toLocaleString()}`;
  } else if (S.condTab==='date') {
    const d = document.getElementById('f-date').value;
    if (!d) { notify('Select a date','','warning'); return; }
    cltvValue = Math.floor(new Date(d).getTime()/1000);
    if (cltvValue<Date.now()/1000) { notify('Date in the past','','warning'); return; }
    condLabel = `Date: ${d}`;
  } else {
    const n = parseInt(document.getElementById('f-halving').value);
    cltvValue = HALVING[n];
    condLabel = `Halving #${n} (Block #${cltvValue.toLocaleString()})`;
  }

  const btn = document.getElementById('createBtn');
  btn.disabled = true;
  const status = document.getElementById('createStatus');
  status.innerHTML = steps(['Preparing anchor','Signing transaction','Broadcasting']);

  try {
    // 1. IDs & commitment
    const anchorId = hex(rand(8));
    const msgHash  = await sha256hex(msg);

    // 2. Encrypt?
    let blob=null, encKey=null, storedMsg=msg;
    if (S.encrypt) {
      const r = await encrypt(msg);
      blob=r.blob; encKey=r.key; storedMsg='[ENCRYPTED]';
    }

    setStep(0,'done'); setStep(1,'active');

    let txid = null;
    let anchorAddr = S.wallet.address; // default: own address

    if (S.wallet.type==='unisat') {
      txid = await sendUniSat(amount, anchorId, msgHash);
    } else {
      txid = await sendOPWallet(amount, anchorId, msgHash);
    }

    setStep(1,'done'); setStep(2,'active');
    setStep(2,'done');

    // 3. Save
    const anchor = {
      id: anchorId, owner: S.wallet.address, walletType: S.wallet.type,
      pubkey: S.wallet.pubkey, message: storedMsg, msgHash,
      encBlob: blob, cltvValue, condLabel, condType: S.condTab,
      address: anchorAddr, amount, txid, encrypted: S.encrypt,
      status: txid?'active':'pending', network:'testnet', createdAt: Date.now(),
    };
    addA(anchor);

    let html = `<div class="success-box">
      <div class="success-label">‚úì Anchor Created</div>
      <div style="font-size:11px;color:var(--muted2);margin-bottom:4px">ID: ${anchorId}</div>
      ${txid?`<a class="txlink" href="https://mempool.space/testnet/tx/${txid}" target="_blank">View transaction ‚Üó</a>`:'<div style="font-size:10px;color:var(--muted)">Saved locally (no txid)</div>'}
    </div>`;

    if (encKey) {
      html += `<div class="key-box">
        <div class="key-label">‚ö† Save Encryption Key ‚Äî Shown Once</div>
        <div class="key-val">${encKey}</div>
        <button class="copy-btn" onclick="copyText('${encKey}',this)">Copy Key</button>
      </div>`;
    }
    status.innerHTML = html;
    notify('Anchor Created!', condLabel, 'success');
    document.getElementById('f-msg').value = '';
    document.getElementById('f-amount').value = '';

  } catch(e) {
    setStep(1,'error');
    status.innerHTML += `<div style="color:var(--red);font-size:11px;margin-top:12px;padding:12px;border:1px solid rgba(192,64,64,.3)">Error: ${e.message}</div>`;
    notify('Creation failed', e.message, 'error');
  }
  btn.disabled = false;
  btn.textContent = 'Create Anchor ‚Üí';
}

/* ‚îÄ‚îÄ‚îÄ UNISAT TX ‚îÄ‚îÄ‚îÄ */
async function sendUniSat(amountSats, anchorId, msgHash) {
  const p = S.wallet.provider;
  // Use PSBT for full control (OP_RETURN + vault address)
  try {
    const utxos = await fetchUTXOs(S.wallet.address);
    if (!utxos||!utxos.length) throw new Error('no_utxo');
    const fee = 2500;
    let sel=[], tot=0;
    for(const u of utxos){ sel.push(u); tot+=u.value; if(tot>=amountSats+fee) break; }
    if(tot<amountSats+fee) throw new Error(`Insufficient: have ${tot} sats`);

    // Self-transfer via signPsbt ‚Äî simple and reliable
    const psbt = await buildSimplePSBT_UniSat(sel, S.wallet.address, amountSats, tot-amountSats-fee, S.wallet.address);
    const signed = await p.signPsbt(psbt, { autoFinalized:true });
    const txid = await broadcastTx(signed);
    return txid;
  } catch(e) {
    if (e.message==='no_utxo') throw new Error('No testnet BTC. Get tBTC at: https://testnet-faucet.mempool.co/');
    // Fallback: sendBitcoin
    if (/Insufficient/i.test(e.message)) throw e;
    notify('Note','Using simple transfer','warning');
    return await p.sendBitcoin(S.wallet.address, amountSats);
  }
}

async function buildSimplePSBT_UniSat(utxos, toAddr, toSats, changeSats, changeAddr) {
  // For UniSat (P2WPKH / tb1q addresses): use PSBT_IN_WITNESS_UTXO only (no taproot key)
  const ver=new Uint8Array([0x02,0,0,0]), lock=new Uint8Array([0,0,0,0]), seq=new Uint8Array([0xfd,0xff,0xff,0xff]);
  const ins=utxos.map(u=>cat(unhex(u.txid).reverse(),uint32LE(u.vout),new Uint8Array([0]),seq));
  const toScript=addrToScript(toAddr);
  const outs=[cat(uint64LE(toSats),varInt(toScript.length),toScript)];
  if(changeSats>=546){const ch=addrToScript(changeAddr);outs.push(cat(uint64LE(changeSats),varInt(ch.length),ch));}
  const utx=cat(ver,varInt(ins.length),...ins,varInt(outs.length),...outs,lock);
  const parts=[new Uint8Array([0x70,0x73,0x62,0x74,0xff])];
  parts.push(kv(new Uint8Array([0x00]),utx));
  parts.push(new Uint8Array([0x00]));
  for(const u of utxos){
    const spk=await fetchScriptPubKey(u.txid,u.vout);
    const wu=cat(uint64LE(u.value),varInt(spk.length),spk);
    parts.push(kv(new Uint8Array([0x01]),wu));
    parts.push(new Uint8Array([0x00]));
  }
  for(let i=0;i<outs.length;i++) parts.push(new Uint8Array([0x00]));
  return hex(cat(...parts));
}

async function fetchScriptPubKey(txid, vout) {
  try {
    const tx = await (await fetch(`${MEMPOOL}/tx/${txid}`)).json();
    return unhex(tx.vout[vout].scriptpubkey);
  } catch(_) { return new Uint8Array([0,20,...rand(20)]); }
}

async function fetchUTXOs(address) {
  const r = await fetch(`${MEMPOOL}/address/${address}/utxo`);
  if (!r.ok) throw new Error(`UTXO fetch failed: ${r.status}`);
  return await r.json();
}

async function broadcastTx(txHex) {
  const r = await fetch(`${MEMPOOL}/tx`, { method:'POST', headers:{'Content-Type':'text/plain'}, body:txHex });
  if (!r.ok) { const t=await r.text(); throw new Error('Broadcast failed: '+t); }
  return await r.text();
}

/* ‚îÄ‚îÄ‚îÄ OP_WALLET TX ‚îÄ‚îÄ‚îÄ */
async function sendOPWallet(amountSats, anchorId, msgHash) {
  const p = S.wallet.provider;

  // Step 1: check address type
  const addr = S.wallet.address;
  if (addr.startsWith('bcrt1')) {
    throw new Error('OP_WALLET is on Regtest. Open OP_WALLET ‚Üí click network icon ‚Üí switch to "OPNet Testnet" ‚Üí reconnect.');
  }

  // Step 2: get UTXOs from OP_WALLET (their own node, no external API needed)
  let utxos;
  try { utxos = await p.getBitcoinUtxos(); } catch(e) { throw new Error('getBitcoinUtxos failed: '+e.message); }
  if (!utxos||!utxos.length) throw new Error('No UTXOs. Get tBTC at: https://faucet.opnet.org/');

  console.log('OP_WALLET UTXOs:', JSON.stringify(utxos.map(u=>({txid:u.transactionId,vout:u.outputIndex,value:u.value,spk:u.scriptPubKey.hex}))));

  // Step 3: select UTXOs
  const FEE = 3000;
  let sel=[], tot=0;
  for (const u of utxos) { sel.push(u); tot+=parseInt(u.value); if(tot>=amountSats+FEE) break; }
  if (tot<amountSats+FEE) throw new Error(`Not enough funds: have ${tot} sats, need ${amountSats+FEE}`);

  const change = tot - amountSats - FEE;

  // Step 4: build PSBT
  const psbtHex = await buildPSBT(sel, addr, amountSats, change, addr);
  console.log('PSBT hex:', psbtHex.slice(0,80)+'...');

  // Step 5: sign
  notify('Approve in OP_WALLET...','Check the popup','info');
  await new Promise(r=>setTimeout(r,200));

  let signed;
  try {
    signed = await Promise.race([
      p.signPsbt(psbtHex, { autoFinalized: true }),
      new Promise((_,rej)=>setTimeout(()=>rej(new Error('signPsbt timed out after 30s')),30000))
    ]);
    console.log('signPsbt OK, len:', signed?.length);
  } catch(e) {
    if (e.code===4001||/reject|cancel/i.test(e.message||'')) throw new Error('Transaction cancelled');
    throw new Error('signPsbt error: '+e.message);
  }

  // Step 6: broadcast via OP_WALLET
  try {
    let result;
    try   { result = await p.pushTx({rawtx: signed}); }
    catch (_) { result = await p.pushPsbt(signed); }
    console.log('broadcast result:', result);
    const txid = typeof result==='string' ? result : result?.txid||result?.hash||null;
    return txid||null;
  } catch(e) {
    throw new Error('Broadcast failed: '+e.message);
  }
}

/* ‚îÄ‚îÄ‚îÄ UI HELPERS ‚îÄ‚îÄ‚îÄ */
function showPage(tab) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('page-'+tab.dataset.page).classList.add('active');
  tab.classList.add('active');
  if (tab.dataset.page==='archive') renderArchive();
}

function setTab(tab, el) {
  S.condTab = tab;
  document.querySelectorAll('.cond-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  ['block','date','halving'].forEach(t=>{ document.getElementById('tab-'+t).style.display=t===tab?'block':'none'; });
  updatePreview();
}

function toggleEncrypt() {
  S.encrypt = !S.encrypt;
  document.getElementById('encRow').classList.toggle('on', S.encrypt);
}

async function updatePreview() {
  const msg = document.getElementById('f-msg').value || 'Your message here...';
  const pm  = document.getElementById('prev-msg');
  pm.textContent = S.encrypt ? '[ENCRYPTED]' : `"${msg}"`;
  pm.style.color = S.encrypt ? 'var(--amber)' : 'var(--text)';

  let cond = 'Set condition above';
  if (S.condTab==='block') { const v=document.getElementById('f-block').value; if(v) cond=`Unlocks at block #${Number(v).toLocaleString()}`; }
  else if (S.condTab==='date') { const v=document.getElementById('f-date').value; if(v) cond=`Unlocks on ${v}`; }
  else { const v=document.getElementById('f-halving').value; cond=`Unlocks at halving #${v}`; }
  document.getElementById('prev-cond').textContent = cond;
  document.getElementById('prev-id').textContent   = '‚Äî ‚Äî ‚Äî ‚Äî (generated on create)';
  if (msg.length>3) {
    const h = await sha256hex(msg);
    document.getElementById('prev-hash').textContent = 'SHA256: '+h.slice(0,32)+'...';
  }
}

function steps(labels) {
  return `<div class="tx-progress">${labels.map((l,i)=>`<div class="tx-step ${i===0?'active':'pending'}" id="step${i}"><div class="step-dot"></div>${l}</div>`).join('')}</div>`;
}
function setStep(i, state) { const el=document.getElementById('step'+i); if(el) el.className='tx-step '+state; }

function refresh() {
  refreshStats();
  renderMyAnchors();
}

function refreshStats() {
  const mine = myAnchors();
  document.getElementById('s-total').textContent = mine.length;
  document.getElementById('s-active').textContent = mine.filter(a=>a.status==='active').length;
  document.getElementById('s-unlock').textContent = mine.filter(a=>canUnlock(a)).length;
  const next = mine.filter(a=>a.status!=='spent').sort((a,b)=>a.cltvValue-b.cltvValue)[0];
  document.getElementById('s-next').textContent = next ? (next.cltvValue<500000000?'#'+next.cltvValue.toLocaleString():new Date(next.cltvValue*1000).getFullYear()) : '‚Äî';
  document.getElementById('myCount').textContent = mine.length;
}

function myAnchors() {
  return S.wallet ? S.anchors.filter(a=>a.owner===S.wallet.address) : [];
}

function canUnlock(a) {
  return a.cltvValue<500000000 ? S.block>=a.cltvValue : Math.floor(Date.now()/1000)>=a.cltvValue;
}

function getStatus(a) {
  if (a.status==='spent') return 'spent';
  if (canUnlock(a)) return 'unlockable';
  if (a.txid) return 'active';
  return 'pending';
}

function renderMyAnchors() {
  const el = document.getElementById('myList');
  if (!S.wallet) {
    el.innerHTML = `<div class="connect-prompt">
      <div class="cp-title">Connect your wallet to begin</div>
      <div class="cp-sub">Connect UniSat or OP_WALLET to create<br>and manage your time-locked anchors.</div>
      <div class="cp-btns">
        <button class="btn-sec" onclick="connectWallet('unisat')">üü† UniSat</button>
        <button class="btn-sec" onclick="connectWallet('opnet')">üîµ OP_WALLET</button>
      </div>
    </div>`;
    return;
  }
  const mine = myAnchors();
  if (!mine.length) {
    el.innerHTML = `<div class="empty"><span class="empty-icon">‚¨°</span>No anchors yet</div>`;
    return;
  }
  el.innerHTML = mine.map((a,i)=>`
    <div class="anchor-row ${a.encrypted?'enc':'pub'}" onclick="openModal('${a.id}')" style="animation-delay:${i*.05}s">
      <div class="ar-id">ID: <span>${a.id.slice(0,8)}...</span></div>
      <div class="ar-msg ${a.encrypted?'enc':''}">${a.encrypted?'üîí Encrypted message':`"${a.message}"`}</div>
      <div class="ar-cond"><strong>${a.condLabel}</strong>${canUnlock(a)?'<br><span style="color:var(--amber)">Ready!</span>':''}</div>
      <span class="pill ${getStatus(a)}">${getStatus(a)}</span>
    </div>`).join('');
}

/* ‚îÄ‚îÄ‚îÄ ARCHIVE ‚îÄ‚îÄ‚îÄ */
function setFilter(f, el) {
  S.archFilter = f;
  document.querySelectorAll('.fbtn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  renderArchive();
}

function renderArchive() {
  let list = [...S.anchors];
  if (S.archFilter==='mine'&&S.wallet) list=list.filter(a=>a.owner===S.wallet.address);
  else if (['active','unlockable','spent'].includes(S.archFilter)) list=list.filter(a=>getStatus(a)===S.archFilter);

  document.getElementById('archCount').textContent = list.length;
  const body = document.getElementById('archBody');
  if (!list.length) { body.innerHTML=`<tr><td colspan="6"><div class="empty"><span class="empty-icon">‚¨°</span>No anchors</div></td></tr>`; return; }

  body.innerHTML = list.map(a=>{
    const mine = S.wallet&&a.owner===S.wallet.address;
    return `<tr class="${mine?'mine':''}" onclick="openModal('${a.id}')">
      <td style="color:var(--gold);font-family:'DM Mono',monospace">${a.id.slice(0,12)}...</td>
      <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${a.encrypted?'üîí Encrypted':a.message}</td>
      <td>${a.condLabel}</td>
      <td><span class="pill ${getStatus(a)}">${getStatus(a)}</span></td>
      <td>${a.encrypted?'<span style="color:var(--amber)">encrypted</span>':'public'}</td>
      <td style="color:var(--muted)">${ago(a.createdAt)}</td>
    </tr>`;
  }).join('');
}

/* ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ */
function openModal(id) {
  const a = S.anchors.find(x=>x.id===id);
  if (!a) return;
  document.getElementById('mTitle').textContent = `Anchor ${a.id.slice(0,8)}...`;

  const rows = [
    ['Anchor ID', a.id],
    ['Status', `<span class="pill ${getStatus(a)}">${getStatus(a)}</span>`],
    ['Condition', a.condLabel],
    ['Amount', a.amount?a.amount.toLocaleString()+' sats':'‚Äî'],
    ['Network', a.network],
    ['Owner', trunc(a.owner||'‚Äî')],
    ['TXID', a.txid?`<a class="txlink" href="https://mempool.space/testnet/tx/${a.txid}" target="_blank">${trunc(a.txid,16)} ‚Üó</a>`:'‚Äî'],
  ];

  let body = rows.map(([k,v])=>`<div class="modal-row"><span class="modal-key">${k}</span><span class="modal-val">${v}</span></div>`).join('');

  body += `<div class="msg-box"><div class="msg-box-label">Message</div>`;
  if (a.encrypted) {
    body += `<div class="msg-text enc" id="mMsgText">üîí Encrypted ‚Äî enter key to reveal</div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <input type="text" class="field-input" id="mKeyInput" placeholder="Paste encryption key..." style="flex:1">
        <button class="btn-sec" onclick="revealMsg('${id}')">Reveal</button>
      </div>`;
  } else {
    body += `<div class="msg-text">"${a.message}"</div>`;
  }
  body += '</div>';
  document.getElementById('mBody').innerHTML = body;

  const mine = S.wallet&&a.owner===S.wallet.address;
  document.getElementById('mActions').innerHTML =
    `<button class="btn-sec" onclick="copyText('${a.id}',this)">Copy ID</button>` +
    (mine&&canUnlock(a)?`<button class="btn-primary" style="flex:1" onclick="unlockAnchor('${id}')">Unlock & Claim ‚Üí</button>`:'');

  document.getElementById('modal').classList.add('open');
}

async function revealMsg(id) {
  const a   = S.anchors.find(x=>x.id===id);
  const key = document.getElementById('mKeyInput').value.trim();
  const el  = document.getElementById('mMsgText');
  if (!key) { el.textContent='Enter key first'; return; }
  try {
    const plain = await decrypt(a.encBlob, key);
    el.className = 'msg-text';
    el.textContent = `"${plain}"`;
  } catch(_) { el.textContent = '‚ùå Wrong key'; }
}

async function unlockAnchor(id) {
  notify('Coming soon','Unlock tx signing in next update','info');
}

function closeModal() { document.getElementById('modal').classList.remove('open'); }
function closeModalOuter(e) { if(e.target.id==='modal') closeModal(); }

/* ‚îÄ‚îÄ‚îÄ NOTIFICATIONS ‚îÄ‚îÄ‚îÄ */
function notify(title, sub, type='info') {
  const icons={success:'‚úì',error:'‚úï',warning:'‚ö†',info:'‚Ñπ'};
  const wrap=document.getElementById('notifs');
  const el=document.createElement('div');
  el.className=`notif ${type}`;
  el.innerHTML=`<div class="notif-icon">${icons[type]}</div><div><div class="notif-title">${title}</div>${sub?`<div class="notif-sub">${sub}</div>`:''}</div>`;
  wrap.appendChild(el);
  setTimeout(()=>{el.style.transition='all .3s';el.style.opacity='0';el.style.transform='translateX(20px)';setTimeout(()=>el.remove(),300);},4000);
}

/* ‚îÄ‚îÄ‚îÄ MISC ‚îÄ‚îÄ‚îÄ */
function trunc(s,n=12) { if(!s||s.length<=n*2) return s||'‚Äî'; return s.slice(0,n)+'...'+s.slice(-6); }
function ago(ts) { const s=Math.floor((Date.now()-ts)/1000); if(s<60) return 'just now'; if(s<3600) return Math.floor(s/60)+'m ago'; if(s<86400) return Math.floor(s/3600)+'h ago'; return Math.floor(s/86400)+'d ago'; }
async function copyText(t, btn) { await navigator.clipboard.writeText(t); if(btn){const o=btn.textContent;btn.textContent='Copied!';setTimeout(()=>btn.textContent=o,1500);} }

/* ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ */
load();
fetchBlock();
setInterval(fetchBlock, 30000);
refresh();
updatePreview();
document.getElementById('myList').innerHTML = `<div class="connect-prompt">
  <div class="cp-title">Connect your wallet to begin</div>
  <div class="cp-sub">Connect UniSat or OP_WALLET to create<br>and manage your time-locked anchors.</div>
  <div class="cp-btns">
    <button class="btn-sec" onclick="connectWallet('unisat')">üü† UniSat</button>
    <button class="btn-sec" onclick="connectWallet('opnet')">üîµ OP_WALLET</button>
  </div>
</div>`;
</script>
</body>
</html>
